<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 10px; }
    h2 { margin: 40px 0 10px; color: #333; }

    /* Locker ID banner */
    #lockerId {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      padding: 8px 12px;
      background: #f3f4f6;
      border-left: 4px solid #2563eb;
    }

    /* Chart + label layout */
    .chart-container {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    canvas {
      flex: 0 0 75%;   /* 75% width */
      height: 280px;   /* fixed height for consistency */
    }
    .chart-label {
      flex: 0 0 25%;   /* 25% width */
      font-size: 14px;
      line-height: 1.4;
      background: #fafafa;
      border: 1px solid #e5e7eb;
      padding: 8px;
      border-radius: 4px;
    }

    /* Map */
    #map { height: 400px; border: 1px solid #ccc; margin-top: 20px; }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 30px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Locker ID will be filled by JS -->
  <div id="lockerId">Locker ID: ...</div>

  <h1>üìä Bike Telemetry Dashboard</h1>

  <!-- BATTERY -->
  <h2>Battery Level (%)</h2>
  <div class="chart-container">
    <canvas id="batteryChart"></canvas>
    <div id="batteryLabel" class="chart-label">Loading‚Ä¶</div>
  </div>

  <!-- SPEED -->
  <h2>Speed (km/h)</h2>
  <div class="chart-container">
    <canvas id="speedChart"></canvas>
    <div id="speedLabel" class="chart-label">Loading‚Ä¶</div>
  </div>

  <!-- RIDING MILEAGE -->
  <h2>Riding Mileage (km)</h2>
  <div class="chart-container">
    <canvas id="ridingChart"></canvas>
    <div id="ridingLabel" class="chart-label">Loading‚Ä¶</div>
  </div>

  <!-- LOCK STATUS -->
  <h2>Lock Status (üîí / üîì)</h2>
  <div class="chart-container">
    <canvas id="lockChart"></canvas>
    <div id="lockLabel" class="chart-label">Loading‚Ä¶</div>
  </div>

  <!-- MAP -->
  <h2>üìç Live Location Map</h2>
  <div id="map"></div>

  <button onclick="exportCSV()">üì• Export CSV with Location</button>

  <script>
    let filteredData = [];

    async function loadDashboard() {
      try {
        const response = await fetch("/data");
        if (!response.ok) throw new Error(`Server returned ${response.status}`);
        const data = await response.json();

        // ------------ FILTER TELEMETRY -------------
        filteredData = data.filter(item => item.topic === "bike/lock" && item.payload);
        if (filteredData.length === 0) throw new Error("No bike/lock data found.");

        // Fill Locker ID banner
        const lockerId = filteredData[0].payload.id || "Unknown";
        document.getElementById("lockerId").textContent = `Locker ID: ${lockerId}`;

        // Labels & series
        const labels = filteredData.map(i => new Date(i.payload.timestamp).toLocaleString());
        const battery = filteredData.map(i => i.payload.battery);
        const speed   = filteredData.map(i => i.payload.speed);
        const riding  = filteredData.map(i => i.payload.riding_mileage);
        const lockStatus = filteredData.map(i => i.payload.lock_status === "Unlocked" ? 1 : 0);

        // Base chart options
        const baseOptions = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                title: items => `Time: ${items[0].label}`
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Timestamp' },
              ticks: { maxRotation: 45, minRotation: 45 }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Value' }
            }
          }
        };

        // Helper to update label
        const setLabel = (id, text) => {
          document.getElementById(id).textContent = text;
        };

        // BATTERY
        const batteryChart = new Chart(document.getElementById('batteryChart').getContext('2d'), {
          type: 'line',
          data: { labels, datasets: [{ label: 'Battery (%)', data: battery, borderColor: '#10b981', fill: false, tension: 0.4 }] },
          options: baseOptions
        });
        setLabel('batteryLabel', `üîã Battery: ${battery.slice(-1)[0]} %`);

        // SPEED
        const speedChart = new Chart(document.getElementById('speedChart').getContext('2d'), {
          type: 'line',
          data: { labels, datasets: [{ label: 'Speed (km/h)', data: speed, borderColor: '#3b82f6', fill: false, tension: 0.4 }] },
          options: baseOptions
        });
        setLabel('speedLabel', `üö¥‚Äç‚ôÇÔ∏è Speed: ${speed.slice(-1)[0]} km/h`);

        // RIDING
        const ridingChart = new Chart(document.getElementById('ridingChart').getContext('2d'), {
          type: 'line',
          data: { labels, datasets: [{ label: 'Riding Mileage (km)', data: riding, borderColor: '#f59e0b', fill: false, tension: 0.4 }] },
          options: baseOptions
        });
        setLabel('ridingLabel', `üìè Mileage: ${riding.slice(-1)[0]} km`);

        // LOCK STATUS
        const lockChart = new Chart(document.getElementById('lockChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Lock Status',
              data: lockStatus,
              backgroundColor: lockStatus.map(v => v === 1 ? '#10b981' : '#ef4444')
            }]
          },
          options: {
            ...baseOptions,
            scales: {
              x: baseOptions.scales.x,
              y: {
                beginAtZero: true,
                max: 1,
                ticks: { callback: v => v === 1 ? 'Unlocked' : 'Locked' },
                title: { display: true, text: 'Lock Status' }
              }
            }
          }
        });
        setLabel('lockLabel', lockStatus.slice(-1)[0] === 1 ? 'üîì Unlocked' : 'üîí Locked');

        // ------------- MAP -------------
        const locations = data
          .filter(i => i.topic === "bike/location" && i.payload)
          .map(i => {
            const p = i.payload;
            const lat = p.lat ?? (Array.isArray(p.coordinates) ? p.coordinates[1] : null);
            const lon = p.lon ?? (Array.isArray(p.coordinates) ? p.coordinates[0] : null);
            const time = p.timestamp || new Date().toISOString();
            return { lat, lon, time };
          })
          .filter(l => typeof l.lat === 'number' && typeof l.lon === 'number');

        if (locations.length) {
          const latest = locations.at(-1);
          const map = L.map('map').setView([latest.lat, latest.lon], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
          }).addTo(map);
          const icon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/747/747376.png',
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, -10]
          });
          L.marker([latest.lat, latest.lon], { icon })
            .addTo(map)
            .bindPopup(`üö≤ Latest Location<br>${new Date(latest.time).toLocaleString()}`)
            .openPopup();
          const path = locations.map(l => [l.lat, l.lon]);
          L.polyline(path, { color: '#3b82f6', weight: 4, opacity: 0.7 }).addTo(map);
        }

      } catch (err) {
        console.error(err);
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red;">Failed: ${err.message}</p>`);
      }
    }

    function exportCSV() {
      if (!filteredData.length) return alert('No data to export');
      const headers = ['Timestamp','Battery','Speed','Riding Mileage','Lock Status','Latitude','Longitude'];
      const rows = filteredData.map(i => {
        const p = i.payload;
        const ts = p.timestamp ? new Date(p.timestamp).toISOString() : '';
        const lat = p.lat ?? (Array.isArray(p.coordinates) ? p.coordinates[1] : '');
        const lon = p.lon ?? (Array.isArray(p.coordinates) ? p.coordinates[0] : '');
        return [ts, p.battery??'', p.speed??'', p.riding_mileage??'', p.lock_status??'', lat, lon].join(',');
      });
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'bike_data.csv' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Load charts on page ready
    window.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>
