<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    .chart-row { display: flex; gap: 12px; margin: 40px 0; }
    .chart-row canvas { flex: 3; }
    .value-panel { flex: 1; background: #f9f9f9; padding: 12px; border: 1px solid #ccc; border-radius: 6px; text-align: center; }
    #map { height: 350px; margin-top: 40px; border: 1px solid #ccc; }
    #map.empty { display: flex; align-items: center; justify-content: center; color: #777; font-style: italic; }
  </style>
</head>
<body>
  <h1>üìä Bike Telemetry Dashboard</h1>
  <h2 id="lockerId">Locker ID: Unknown</h2>

  <!-- Battery -->
  <div class="chart-row">
    <canvas id="batteryChart"></canvas>
    <div class="value-panel"><h3>Battery</h3><p id="batteryValue">-- %</p></div>
  </div>
  <!-- Speed -->
  <div class="chart-row">
    <canvas id="speedChart"></canvas>
    <div class="value-panel"><h3>Speed</h3><p id="speedValue">-- km/h</p></div>
  </div>
  <!-- Mileage -->
  <div class="chart-row">
    <canvas id="mileageChart"></canvas>
    <div class="value-panel"><h3>Mileage</h3><p id="mileageValue">-- km</p></div>
  </div>
  <!-- Lock Status -->
  <div class="chart-row">
    <canvas id="lockChart"></canvas>
    <div class="value-panel"><h3>Lock</h3><p id="lockValue">--</p></div>
  </div>

  <h2>üìç Live Location Map</h2>
  <div id="map" class="empty">No location data yet‚Ä¶</div>

  <script>
    let allData = [];
    let mapInstance;

    function setLabel(id, value, unit = "") {
      document.getElementById(id).textContent = (value ?? "--") + (value ? ` ${unit}` : "");
    }

    function LL(p) {
      return { lat: p.lat ?? p.latitude, lon: p.lon ?? p.longitude };
    }

    async function loadDashboard() {
      try {
        const res = await fetch('/data');
        allData = await res.json();
        if (!Array.isArray(allData) || allData.length === 0) throw new Error('No data');

        const idMsg = allData.find(d => d?.payload?.id);
        if (idMsg) document.getElementById('lockerId').textContent = `Locker ID: ${idMsg.payload.id}`;

        const lockMsgs = allData.filter(i => i.topic?.endsWith('lock') && i.payload);

        // Generate synthetic ISO 8601 timestamps spaced 1s apart
        const start = Date.now();
        const lbl = lockMsgs.map((_, i) => new Date(start + i * 1000).toISOString());

        const batt = lockMsgs.map(i => i.payload.battery);
        const spd = lockMsgs.map(i => i.payload.speed);
        const mil = lockMsgs.map(i => i.payload.riding_mileage);
        const lck = lockMsgs.map(i => i.payload.lock_status === 'Unlocked' ? 1 : 0);

        const base = {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Time' }, ticks: { maxTicksLimit: 10 } },
            y: { beginAtZero: true }
          }
        };

        new Chart('batteryChart', {
          type: 'line',
          data: { labels: lbl, datasets: [{ data: batt, borderColor: '#27ae60', tension: .4 }] },
          options: base
        });
        setLabel('batteryValue', batt.at(-1), '%');

        new Chart('speedChart', {
          type: 'line',
          data: { labels: lbl, datasets: [{ data: spd, borderColor: '#2980b9', tension: .4 }] },
          options: base
        });
        setLabel('speedValue', spd.at(-1), 'km/h');

        new Chart('mileageChart', {
          type: 'line',
          data: { labels: lbl, datasets: [{ data: mil, borderColor: '#e67e22', tension: .4 }] },
          options: base
        });
        setLabel('mileageValue', mil.at(-1), 'km');

        // Updated Lock chart (icons only, no bars)
        new Chart('lockChart', {
          type: 'bar',
          data: {
            labels: lbl,
            datasets: [{
              data: lck,
              backgroundColor: 'transparent', // no bar fill
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'start',
                font: { size: 20 },
                formatter: (v) => v ? 'üîì' : 'üîí',
                color: (ctx) => ctx.raw ? '#2ecc71' : '#e74c3c'
              }
            },
            scales: {
              x: { title: { display: true, text: 'Time' }, ticks: { maxTicksLimit: 10 } },
              y: { display: false }
            }
          },
          plugins: [ChartDataLabels]
        });

        setLabel('lockValue', lck.at(-1) ? 'Unlocked' : 'Locked');
        renderMap();
      } catch (err) {
        console.error(err);
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red;">${err.message}</p>`);
      }
    }

    function renderMap() {
      const valid = allData.filter(m => {
        const { lat, lon } = LL(m.payload || {});
        return lat && lon;
      });

      if (!valid.length) return;

      const last = valid.at(-1).payload;
      if (mapInstance) mapInstance.remove();
      document.getElementById('map').classList.remove('empty');

      mapInstance = L.map('map').setView([last.lat, last.lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);

      const coords = valid.map(m => [m.payload.lat, m.payload.lon]);
      const polyline = L.polyline(coords, { color: 'blue' }).addTo(mapInstance);
      mapInstance.fitBounds(polyline.getBounds());

      L.marker([last.lat, last.lon])
        .addTo(mapInstance)
        .bindPopup(`üö≤ Latest<br>${new Date(last.timestamp).toLocaleString()}`)
        .openPopup();
    }

    loadDashboard();
  </script>
</body>
</html>
