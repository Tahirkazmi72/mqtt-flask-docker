<!DOCTYPE html>
<html>
<head>
  <title>Bike Dashboard with Map + Export + Tabs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    nav { display: flex; background: #333; }
    nav button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      color: white;
      background: #333;
      border: none;
      cursor: pointer;
    }
    nav button.active { background: #555; }
    .tab { display: none; padding: 20px; }
    canvas { margin-bottom: 40px; max-width: 100%; }
    #map { height: 400px; width: 100%; }
    .controls { margin-bottom: 15px; }
    .controls label { margin-right: 15px; }
    button.export { margin-top: 10px; padding: 8px 16px; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showTab('charts')" class="active">üìä Charts</button>
    <button onclick="showTab('map')">üó∫Ô∏è Map</button>
  </nav>

  <div id="charts" class="tab" style="display:block">
    <div class="controls">
      <label><input type="checkbox" checked onchange="toggleChart('batteryChart')"> Battery</label>
      <label><input type="checkbox" checked onchange="toggleChart('speedChart')"> Speed</label>
      <label><input type="checkbox" checked onchange="toggleChart('ridingChart')"> Riding</label>
      <label><input type="checkbox" checked onchange="toggleChart('lockChart')"> Lock</label>
    </div>
    <canvas id="batteryChart"></canvas>
    <canvas id="speedChart"></canvas>
    <canvas id="ridingChart"></canvas>
    <canvas id="lockChart"></canvas>
    <button class="export" onclick="exportCSV()">üì• Export CSV</button>
    <button class="export" onclick="loadDashboard()">üîÑ Refresh Now</button>
  </div>

  <div id="mapTab" class="tab">
    <div id="map"></div>
  </div>

  <script>
    let map, dataCache = [];

    function showTab(id) {
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t => t.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      event.target.classList.add("active");
    }

    function toggleChart(id) {
      const c = document.getElementById(id);
      c.style.display = c.style.display === 'none' ? 'block' : 'none';
    }

    function exportCSV() {
      if (!dataCache.length) return alert("No data to export");
      const headers = ["timestamp","battery","speed","riding_mileage","lock_status"];
      const rows = dataCache.map(d => headers.map(h => d[h]).join(","));
      const csv = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "bike_data.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadDashboard() {
      fetch("/data").then(res => res.json()).then(data => {
        const filtered = [];
        let lastTs = 0;
        data.forEach(d => {
          if (d.topic === "bike/lock" && d.payload.timestamp) {
            const ts = new Date(d.payload.timestamp).getTime();
            if (ts - lastTs >= 600000) { // 10 min
              lastTs = ts;
              filtered.push({
                timestamp: d.payload.timestamp,
                battery: d.payload.battery,
                speed: d.payload.speed,
                riding_mileage: d.payload.riding_mileage,
                lock_status: d.payload.lock_status,
                lat: d.payload.lat,
                lon: d.payload.lon
              });
            }
          }
        });

        dataCache = filtered; // save for export
        const labels = filtered.map(d => new Date(d.timestamp).toLocaleTimeString());

        const options = {
          responsive: true,
          scales: {
            x: { ticks: { maxRotation: 45 } },
            y: { beginAtZero: true }
          }
        };

        new Chart(batteryChart, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Battery', data: filtered.map(d => d.battery), borderColor: 'green', tension: 0.4 }] },
          options
        });
        new Chart(speedChart, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Speed', data: filtered.map(d => d.speed), borderColor: 'blue', tension: 0.4 }] },
          options
        });
        new Chart(ridingChart, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Riding', data: filtered.map(d => d.riding_mileage), borderColor: 'orange', tension: 0.4 }] },
          options
        });
        new Chart(lockChart, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Lock Status',
              data: filtered.map(d => d.lock_status === 'Unlocked' ? 1 : 0),
              backgroundColor: filtered.map(d => d.lock_status === 'Unlocked' ? '#2ecc71' : '#e74c3c')
            }]
          },
          options: {
            ...options,
            scales: { y: { beginAtZero: true, max: 1, ticks: { callback: v => v === 1 ? 'Unlocked' : 'Locked' } } }
          }
        });

        // === MAP ===
        const locs = data.filter(d => d.topic === "bike/location").map(d => {
          const p = d.payload;
          return {
            lat: p.lat || (p.coordinates ? p.coordinates[1] : null),
            lon: p.lon || (p.coordinates ? p.coordinates[0] : null),
            time: p.timestamp
          };
        }).filter(p => p.lat && p.lon);

        if (!map && locs.length) {
          const last = locs[locs.length - 1];
          map = L.map('map').setView([last.lat, last.lon], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

          const bikeIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/747/747376.png",
            iconSize: [32, 32], iconAnchor: [16, 16]
          });
          L.marker([last.lat, last.lon], { icon: bikeIcon }).addTo(map).bindPopup("Latest Position").openPopup();
          const path = locs.map(p => [p.lat, p.lon]);
          L.polyline(path, { color: 'blue' }).addTo(map);
        }

        // === LOCK ICONS ===
        const lockEvents = filtered.filter(d => d.lat && d.lon);
        lockEvents.forEach(e => {
          const icon = L.icon({
            iconUrl: e.lock_status === "Unlocked"
              ? "https://cdn-icons-png.flaticon.com/512/61/61457.png"
              : "https://cdn-icons-png.flaticon.com/512/565/565547.png",
            iconSize: [24, 24], iconAnchor: [12, 12]
          });
          L.marker([e.lat, e.lon], { icon }).addTo(map).bindPopup(`${e.lock_status} @ ${new Date(e.timestamp).toLocaleString()}`);
        });
      });
    }

    loadDashboard();
    setInterval(loadDashboard, 60000);
  </script>
</body>
</html>
