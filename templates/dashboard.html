<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <!-- Chart.js & Leaflet CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px}
    h1{margin-bottom:.25rem}

    /* ---------- CHART LAYOUT ---------- */
    .chart-row{display:flex;align-items:center;margin:40px 0;gap:12px}
    .chart-row canvas{flex:0 0 75%;max-width:75%}
    .value-panel{flex:0 0 25%;max-width:25%;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:12px;text-align:center}
    .value-panel h3{margin:4px 0 6px;font-size:1rem;color:#333}
    .value-panel p{margin:0;font-size:1.25rem;font-weight:700}

    /* ---------- MAP ---------- */
    #map{height:350px;border:1px solid #ccc;margin-top:40px}
    #map.empty{display:flex;align-items:center;justify-content:center;color:#777;font-style:italic}

    /* ---------- RESPONSIVE ---------- */
    @media(max-width:800px){
      .chart-row{flex-direction:column}
      .chart-row canvas,.value-panel{flex:0 0 100%;max-width:100%}
    }
  </style>
</head>
<body>
  <h1>üìä Bike Telemetry Dashboard</h1>
  <h2 id="lockerId">Locker ID: Unknown</h2>

  <!-- Battery -->
  <div class="chart-row">
    <canvas id="batteryChart"></canvas>
    <div class="value-panel"><h3>Battery</h3><p id="batteryValue">-- %</p></div>
  </div>
  <!-- Speed -->
  <div class="chart-row">
    <canvas id="speedChart"></canvas>
    <div class="value-panel"><h3>Speed</h3><p id="speedValue">-- km/h</p></div>
  </div>
  <!-- Mileage -->
  <div class="chart-row">
    <canvas id="mileageChart"></canvas>
    <div class="value-panel"><h3>Mileage</h3><p id="mileageValue">-- km</p></div>
  </div>
  <!-- Lock Status -->
  <div class="chart-row">
    <canvas id="lockChart"></canvas>
    <div class="value-panel"><h3>Lock</h3><p id="lockValue">--</p></div>
  </div>

  <h2>üìç Live Location Map</h2>
  <div id="map" class="empty">No location data yet‚Ä¶</div>

  <button onclick="exportCSV()" style="margin-top:30px;padding:10px 20px;font-size:1rem;cursor:pointer">üì• Export CSV</button>

  <script>
    let allData = [];
    let mapInstance = null; // üîë hold global Leaflet map

    /* ----------------- HELPER FUNCTIONS ----------------- */
    function setLabel(id, value, unit = "") {
      const el = document.getElementById(id);
      el.textContent = (value !== undefined && value !== null)
        ? `${value} ${unit}`.trim() : "--";
    }
    function extractLatLon(p) {
      const lat = p.lat ?? p.latitude ?? (Array.isArray(p.coordinates) ? p.coordinates[1] : null);
      const lon = p.lon ?? p.longitude ?? (Array.isArray(p.coordinates) ? p.coordinates[0] : null);
      return { lat, lon };
    }

    /* ----------------- DASHBOARD CORE ------------------- */
    async function loadDashboard() {
      try {
        const res = await fetch("/data");
        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        allData = await res.json();
        if (!Array.isArray(allData) || !allData.length) throw new Error("No data received");

        // Locker ID
        const idMsg = allData.find(d => d?.payload?.id);
        if (idMsg) document.getElementById("lockerId").textContent = `Locker ID: ${idMsg.payload.id}`;

        /* -------- FILTER BIKE/LOCK -------- */
        const lockMsgs = allData.filter(i => i.topic?.endsWith("lock") && i.payload);
        const labels   = lockMsgs.map(i => new Date(i.payload.timestamp || Date.now()).toLocaleTimeString());
        const battery  = lockMsgs.map(i => i.payload.battery);
        const speed    = lockMsgs.map(i => i.payload.speed);
        const mileage  = lockMsgs.map(i => i.payload.riding_mileage);
        const lockStat = lockMsgs.map(i => i.payload.lock_status === "Unlocked" ? 1 : 0);

        const baseOpt = {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "Time" } },
            y: { beginAtZero: true }
          }
        };

        new Chart("batteryChart", { type: "line", data: { labels, datasets: [{ data: battery, borderColor: "#27ae60", tension: .4 }] }, options: baseOpt });
        setLabel("batteryValue", battery.at(-1), "%");

        new Chart("speedChart", { type: "line", data: { labels, datasets: [{ data: speed, borderColor: "#2980b9", tension: .4 }] }, options: baseOpt });
        setLabel("speedValue", speed.at(-1), "km/h");

        new Chart("mileageChart", { type: "line", data: { labels, datasets: [{ data: mileage, borderColor: "#e67e22", tension: .4 }] }, options: baseOpt });
        setLabel("mileageValue", mileage.at(-1), "km");

        new Chart("lockChart", {
          type: "bar",
          data: { labels, datasets: [{ data: lockStat, backgroundColor: lockStat.map(v => v ? "#2ecc71" : "#e74c3c") }] },
          options: { ...baseOpt, scales: { ...baseOpt.scales, y: { beginAtZero: true, max: 1, ticks: { callback: v => v ? "Unlocked" : "Locked" } } } }
        });
        setLabel("lockValue", lockStat.at(-1) ? "Unlocked" : "Locked");

        /* --------------- MAP SECTION --------------- */
        renderMap();

      } catch (err) {
        console.error(err);
        document.body.insertAdjacentHTML("beforeend", `<p style='color:red;'>${err.message}</p>`);
      }
    }

    function destroyExistingLeafletMap() {
      // If mapInstance already tracked
      if (mapInstance) {
        mapInstance.off();
        mapInstance.remove();
        mapInstance = null;
      }
      // If any orphan Leaflet object still bound to container
      const mapElem = document.getElementById("map");
      if (mapElem && mapElem._leaflet_id) {
        try { mapElem._leaflet_id = null; } catch(e) { /* ignore */ }
      }
      mapElem.innerHTML = ""; // clear children (tile layers, etc.)
    }

    function renderMap() {
      const locMsgs = allData.filter(i => i.payload && extractLatLon(i.payload).lat !== null);
      const locs = locMsgs.map(m => {
        const { lat, lon } = extractLatLon(m.payload);
        return { lat, lon, time: m.payload.timestamp || Date.now() };
      });

      const mapContainer = document.getElementById("map");

      // Reset / destroy earlier map safely
      destroyExistingLeafletMap();

      if (!locs.length) {
        mapContainer.textContent = "No location data yet‚Ä¶";
        mapContainer.classList.add("empty");
        return;
      }
      mapContainer.classList.remove("empty");

      const last = locs.at(-1);
      mapInstance = L.map("map", { attributionControl: false }).setView([last.lat, last.lon], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap" }).addTo(mapInstance);

      L.marker([last.lat, last.lon]).add
