<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <!-- Charts & Map libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
    h1{margin-bottom:6px}
    h2{margin:24px 0 8px}

    /* --- CHART ROW --- */
    .chart-row{display:flex;align-items:center;gap:12px;margin:32px 0}
    .chart-row canvas{flex:0 0 75%;max-width:75%}
    .value-panel{flex:0 0 25%;max-width:25%;background:#fff;border:1px solid #ddd;border-radius:6px;padding:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .value-panel h3{margin:2px 0 4px;font-size:1rem;color:#555}
    .value-panel p{margin:0;font-size:1.25rem;font-weight:700;color:#111}

    #map{height:350px;border:1px solid #ccc;margin-top:32px}
    #map.empty{display:flex;align-items:center;justify-content:center;color:#666;font-style:italic}

    button{padding:10px 20px;font-size:1rem;cursor:pointer;margin-top:26px;border:none;border-radius:4px;background:#3498db;color:#fff}
    button:hover{background:#2980b9}

    @media(max-width:800px){
      .chart-row{flex-direction:column}
      .chart-row canvas,.value-panel{flex:0 0 100%;max-width:100%}
    }
  </style>
</head>
<body>
  <h1>üìä Bike Telemetry Dashboard</h1>
  <h2 id="lockerId">Locker ID: Unknown</h2>

  <div class="chart-row">
    <canvas id="batteryChart"></canvas>
    <div class="value-panel"><h3>Battery</h3><p id="batteryValue">-- %</p></div>
  </div>

  <div class="chart-row">
    <canvas id="speedChart"></canvas>
    <div class="value-panel"><h3>Speed</h3><p id="speedValue">-- km/h</p></div>
  </div>

  <div class="chart-row">
    <canvas id="mileageChart"></canvas>
    <div class="value-panel"><h3>Mileage</h3><p id="mileageValue">-- km</p></div>
  </div>

  <div class="chart-row">
    <canvas id="lockChart"></canvas>
    <div class="value-panel"><h3>Lock</h3><p id="lockValue">--</p></div>
  </div>

  <h2>üìç Live Location Map</h2>
  <div id="map" class="empty">Loading map‚Ä¶</div>

  <button id="exportBtn">üì• Export CSV</button>

  <script>
    let allData=[];
    const CHARTS={}; // store chart instances for reuse

    function fmt(val,unit=""){return (val||val===0)?`${val} ${unit}`.trim():"--"}
    function setLabel(id,val,unit=""){const el=document.getElementById(id); if(el) el.textContent=fmt(val,unit)}

    // Robust timestamp formatter
    function formatTimestamp(ts){
      if(!ts && ts!==0) return "";
      // numeric? assume epoch (sec or ms)
      if(typeof ts==="number"){ if(ts<1e12) ts*=1000; return new Date(ts).toLocaleString(); }
      // ISO string or other ‚Äì let Date parse
      return new Date(ts).toLocaleString();
    }

    async function fetchData(){
      const res=await fetch("/data");
      if(!res.ok) throw new Error(`Server ${res.status}`);
      const json=await res.json();
      if(!Array.isArray(json)||!json.length) throw new Error("No data returned");
      return json;
    }

    async function loadDashboard(){
      try{
        allData=await fetchData();

        // locker id (first message that contains it)
        const idMsg=allData.find(m=>m.payload&&m.payload.id);
        if(idMsg) document.getElementById("lockerId").textContent=`Locker ID: ${idMsg.payload.id}`;

        /* ================== LOCK MESSAGES ================== */
        const lockMsgs=allData.filter(m=>m.topic==="bike/lock"&&m.payload);

        const labels   = lockMsgs.map(m=>formatTimestamp(m.payload.timestamp));
        const battery  = lockMsgs.map(m=>m.payload.battery ?? null);
        const speed    = lockMsgs.map(m=>m.payload.speed ?? null);
        const mileage  = lockMsgs.map(m=>m.payload.riding_mileage ?? null);
        const lockStat = lockMsgs.map(m=>m.payload.lock_status==="Unlocked"?1:0);

        renderChart("batteryChart","line",labels,"Battery",battery,"#27ae60");
        renderChart("speedChart","line",labels,"Speed",speed,"#2980b9");
        renderChart("mileageChart","line",labels,"Mileage",mileage,"#e67e22");
        renderChart("lockChart","bar",labels,"Lock",lockStat,lockStat.map(v=>v?"#2ecc71":"#e74c3c"),true);

        setLabel("batteryValue",battery.at(-1),"%");
        setLabel("speedValue",speed.at(-1),"km/h");
        setLabel("mileageValue",mileage.at(-1),"km");
        setLabel("lockValue",lockStat.at(-1)?"Unlocked":"Locked");

        /* ================== LOCATION ================== */
        const locMsgs=allData.filter(m=>{
          const p=m.payload||{};
          return (typeof p.lat==="number"&&typeof p.lon==="number")||
                 (Array.isArray(p.coordinates)&&p.coordinates.length>=2&&typeof p.coordinates[0]==="number"&&typeof p.coordinates[1]==="number");
        });
        const locs=locMsgs.map(m=>{
          const p=m.payload||{};
          const lat=typeof p.lat==="number"?p.lat:(Array.isArray(p.coordinates)?p.coordinates[1]:null);
          const lon=typeof p.lon==="number"?p.lon:(Array.isArray(p.coordinates)?p.coordinates[0]:null);
          return {lat,lon,time:p.timestamp||Date.now()};
        }).filter(l=>typeof l.lat==="number"&&typeof l.lon==="number");
        setupMap(locs);

      }catch(err){
        console.error(err);
        document.getElementById("map").textContent=`Error: ${err.message}`;
      }
    }

    // render or update chart
    function renderChart(canvasId,type,labels,label,data,color,lockChart=false){
      if(CHARTS[canvasId]){ // update existing chart
        CHARTS[canvasId].data.labels=labels;
        CHARTS[canvasId].data.datasets[0].data=data;
        if(lockChart){
          CHARTS[canvasId].data.datasets[0].backgroundColor=color;
        }
        CHARTS[canvasId].update();
        return;
      }
      const optBase={
        responsive:true,
        plugins:{legend:{display:false}},
        scales:{
          x:{title:{display:true,text:"Time"},ticks:{maxRotation:45,minRotation:45}},
          y:{beginAtZero:true}
        }
      };
      if(lockChart){
        optBase.scales.y={beginAtZero:true,max:1,ticks:{callback:v=>v?"Unlocked":"Locked"}};
      }
      CHARTS[canvasId]=new Chart(document.getElementById(canvasId),{
        type:type,
        data:{labels,datasets:[{label,data,borderColor:color,backgroundColor:color,fill:false,tension:0.4}]},
        options:optBase
      });
    }

    function setupMap(locs){
      const mapDiv=document.getElementById("map");
      mapDiv.classList.remove("empty");
      mapDiv.innerHTML="";
      if(!locs.length){
        mapDiv.classList.add("empty");
        mapDiv.textContent="No location data available";
        return;
      }
      const latest=locs.at(-1);
      const map=L.map("map").setView([latest.lat,latest.lon],15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors"}).addTo(map);
      const path=locs.map(l=>[l.lat,l.lon]);
      L.polyline(path,{color:"blue",weight:3,opacity:0.7}).addTo(map);
      L.marker([latest.lat,latest.lon]).addTo(map).bindPopup(`üö≤ ${new Date(latest.time).toLocaleString()}`).openPopup();
      setTimeout(()=>map.invalidateSize(),200);
    }

    function exportCSV(){
      if(!allData.length) return alert("No data");
      const header=["topic","timestamp","battery","speed","mileage","lock_status","lat","lon"];
      const rows=allData.map(m=>{
        const p=m.payload||{};
        const ts=p.timestamp?formatTimestamp(p.timestamp):"";
        const lat=typeof p.lat==="number"?p.lat:(Array.isArray(p.coordinates)?p.coordinates[1]:"");
        const lon=typeof p.lon==="number"?p.lon:(Array.isArray(p.coordinates)?p.coordinates[0]:"");
        return [m.topic,ts,p.battery??"",p.speed??"",p.riding_mileage??"",p.lock_status??"",lat,lon].join(",");
      });
      const csv=[header.join(","),...rows].join("\n");
      const blob=new Blob([csv],{type:"text/csv"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;a.download="bike_data.csv";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
    }

    document.getElementById("exportBtn").addEventListener("click",exportCSV);

    // Initial load + periodic refresh (5¬†s)
    loadDashboard();
    setInterval(loadDashboard,5000);
  </script>
</body>
</html>
