<!DOCTYPE html>
<html>
<head>
  <title>Bike Dashboard with Map</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    canvas {
      margin-bottom: 50px;
    }
    h2 {
      margin-top: 60px;
      color: #333;
    }
    #map {
      height: 400px;
      margin-top: 50px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>üìä Bike Telemetry Dashboard</h1>

  <h2>Battery Level (%)</h2>
  <canvas id="batteryChart" width="1000" height="300"></canvas>

  <h2>Speed (km/h)</h2>
  <canvas id="speedChart" width="1000" height="300"></canvas>

  <h2>Riding Mileage</h2>
  <canvas id="ridingChart" width="1000" height="300"></canvas>

  <h2>Lock Status (üîí = Locked, üîì = Unlocked)</h2>
  <canvas id="lockChart" width="1000" height="300"></canvas>

  <h2>üìç Live Location Map</h2>
  <div id="map"></div>

  <button onclick="exportCSV()">üì• Export CSV</button>

  <script>
    let filteredData = [];

    async function loadDashboard() {
      try {
        const response = await fetch("/data");
        if (!response.ok) throw new Error(`Server returned ${response.status}`);
        const data = await response.json();

        if (!Array.isArray(data) || data.length === 0) {
          throw new Error("No data received or data is not in expected format.");
        }

        filteredData = data.filter(item =>
          item.topic === "bike/lock" &&
          item.payload &&
          typeof item.payload.battery === "number"
        );

        if (filteredData.length === 0) {
          throw new Error("No valid 'bike/lock' data with battery found.");
        }

        const labels = filteredData.map(item => {
          const ts = item.payload.timestamp || new Date().toISOString();
          return new Date(ts).toLocaleString();
        });

        const battery = filteredData.map(item => item.payload.battery);
        const speed = filteredData.map(item => item.payload.speed);
        const riding = filteredData.map(item => item.payload.riding_mileage);
        const lockStatus = filteredData.map(item =>
          item.payload.lock_status === "Unlocked" ? 1 : 0
        );

        const baseOptions = {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                title: items => `Time: ${items[0].label}`
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Timestamp' },
              ticks: { maxRotation: 45, minRotation: 45 }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Value' }
            }
          }
        };

        new Chart(document.getElementById('batteryChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Battery (%)',
              data: battery,
              borderColor: '#2ecc71',
              fill: false,
              tension: 0.4
            }]
          },
          options: baseOptions
        });

        new Chart(document.getElementById('speedChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Speed (km/h)',
              data: speed,
              borderColor: '#3498db',
              fill: false,
              tension: 0.4
            }]
          },
          options: baseOptions
        });

        new Chart(document.getElementById('ridingChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Riding Mileage',
              data: riding,
              borderColor: '#f39c12',
              fill: false,
              tension: 0.4
            }]
          },
          options: baseOptions
        });

        new Chart(document.getElementById('lockChart'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Lock Status (1=Unlocked, 0=Locked)',
              data: lockStatus,
              backgroundColor: lockStatus.map(v => v === 1 ? '#2ecc71' : '#e74c3c')
            }]
          },
          options: {
            ...baseOptions,
            scales: {
              x: baseOptions.scales.x,
              y: {
                beginAtZero: true,
                max: 1,
                ticks: {
                  callback: v => v === 1 ? 'Unlocked' : 'Locked'
                },
                title: { display: true, text: 'Lock Status' }
              }
            }
          }
        });

        // ========== MAP SETUP ==========
        const locations = data
          .filter(item => item.topic === "bike/location" && item.payload)
          .map(item => {
            const p = item.payload;
            const lat = p.lat ?? (Array.isArray(p.coordinates) ? p.coordinates[1] : null);
            const lon = p.lon ?? (Array.isArray(p.coordinates) ? p.coordinates[0] : null);
            const time = p.timestamp || new Date().toISOString();
            return { lat, lon, time };
          })
          .filter(loc => typeof loc.lat === "number" && typeof loc.lon === "number");

        if (locations.length > 0) {
          const latest = locations[locations.length - 1];
          const mapContainer = document.getElementById("map");
          mapContainer.innerHTML = ""; // clear old map if reloaded

          const map = L.map("map").setView([latest.lat, latest.lon], 16);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
          }).addTo(map);

          const bikeIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/747/747376.png",
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -10]
          });

          L.marker([latest.lat, latest.lon], { icon: bikeIcon })
            .addTo(map)
            .bindPopup(`üö≤ Latest Location<br>üïì ${new Date(latest.time).toLocaleString()}`)
            .openPopup();

          const path = locations.map(loc => [loc.lat, loc.lon]);
          L.polyline(path, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);
        }

      } catch (err) {
        console.error("Error loading charts or map:", err);
        document.body.innerHTML += `<p style='color:red;'>Failed to load data: ${err.message}</p>`;
      }
    }

    function exportCSV() {
      if (!filteredData || filteredData.length === 0) {
        alert("No data to export.");
        return;
      }

      const headers = ["Timestamp", "Battery", "Speed", "Riding Mileage", "Lock Status"];
      const rows = filteredData.map(item => [
        item.payload.timestamp || "",
        item.payload.battery,
        item.payload.speed,
        item.payload.riding_mileage,
        item.payload.lock_status
      ].join(","));

      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "bike_data.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    loadDashboard();
  </script>
</body>
</html>
