<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    h1 { margin-bottom: 10px; }

    /* --- CHART LAYOUT --- */
    .chart-row { display: flex; align-items: center; gap: 12px; margin: 40px 0; }
    .chart-row canvas { flex: 0 0 75%; max-width: 75%; }
    .value-panel { flex: 0 0 25%; max-width: 25%; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; padding: 12px; text-align: center; }
    .value-panel h3 { margin: 4px 0 6px; font-size: 1rem; color: #333; }
    .value-panel p { margin: 0; font-size: 1.25rem; font-weight: bold; }

    /* --- MAP --- */
    #map { height: 350px; border: 1px solid #ccc; margin-top: 40px; }

    /* --- RESPONSIVE --- */
    @media (max-width: 800px) {
      .chart-row { flex-direction: column; }
      .chart-row canvas, .value-panel { max-width: 100%; flex: 0 0 100%; }
    }
  </style>
</head>
<body>
  <h1>üìä Bike Telemetry Dashboard</h1>
  <h2 id="lockerId">Locker ID: Unknown</h2>

  <!-- Battery -->
  <div class="chart-row">
    <canvas id="batteryChart"></canvas>
    <div class="value-panel"><h3>Battery</h3><p id="batteryValue">-- %</p></div>
  </div>

  <!-- Speed -->
  <div class="chart-row">
    <canvas id="speedChart"></canvas>
    <div class="value-panel"><h3>Speed</h3><p id="speedValue">-- km/h</p></div>
  </div>

  <!-- Riding Mileage -->
  <div class="chart-row">
    <canvas id="mileageChart"></canvas>
    <div class="value-panel"><h3>Mileage</h3><p id="mileageValue">-- km</p></div>
  </div>

  <!-- Lock Status -->
  <div class="chart-row">
    <canvas id="lockChart"></canvas>
    <div class="value-panel"><h3>Lock</h3><p id="lockValue">--</p></div>
  </div>

  <h2>üìç Live Location Map</h2>
  <div id="map"></div>

  <button onclick="exportCSV()" style="margin-top:30px; padding:10px 20px;font-size:1rem;cursor:pointer;">üì• Export CSV</button>

  <script>
    let allData = [];

    function setLabel(id, value, unit = "") {
      const el = document.getElementById(id);
      if (el) el.textContent = value !== undefined && value !== null ? `${value} ${unit}`.trim() : "--";
    }

    async function loadDashboard() {
      try {
        const res = await fetch("/data");
        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        allData = await res.json();
        if (!Array.isArray(allData) || !allData.length) throw new Error("No data");

        // Locker ID (first message with id wins)
        const idMsg = allData.find(d => d.payload && d.payload.id);
        if (idMsg) document.getElementById("lockerId").textContent = `Locker ID: ${idMsg.payload.id}`;

        /* --------- FILTERS --------- */
        const lockMsgs = allData.filter(i => i.topic === "bike/lock" && i.payload);
        const locMsgs  = allData.filter(i => i.topic === "bike/location" && i.payload);

        const labels   = lockMsgs.map(i => new Date(i.payload.timestamp || Date.now()).toLocaleString());
        const battery  = lockMsgs.map(i => i.payload.battery);
        const speed    = lockMsgs.map(i => i.payload.speed);
        const mileage  = lockMsgs.map(i => i.payload.riding_mileage);
        const lockStat = lockMsgs.map(i => i.payload.lock_status === "Unlocked" ? 1 : 0);

        /* ---------- CHART OPTIONS ---------- */
        const baseOpt = {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: {display:true,text:"Time"}, ticks:{maxRotation:45,minRotation:45} },
            y: { beginAtZero: true }
          }
        };

        // Battery Chart
        new Chart(document.getElementById("batteryChart"), {
          type: "line",
          data: { labels, datasets:[{data:battery,label:"Battery",borderColor:"#27ae60",fill:false,tension:0.4}] },
          options: baseOpt
        });
        setLabel("batteryValue", battery.at(-1), "%");

        // Speed Chart
        new Chart(document.getElementById("speedChart"), {
          type: "line",
          data: { labels, datasets:[{data:speed,label:"Speed",borderColor:"#2980b9",fill:false,tension:0.4}] },
          options: baseOpt
        });
        setLabel("speedValue", speed.at(-1), "km/h");

        // Mileage Chart
        new Chart(document.getElementById("mileageChart"), {
          type: "line",
          data: { labels, datasets:[{data:mileage,label:"Mileage",borderColor:"#e67e22",fill:false,tension:0.4}] },
          options: baseOpt
        });
        setLabel("mileageValue", mileage.at(-1), "km");

        // Lock Chart
        new Chart(document.getElementById("lockChart"), {
          type: "bar",
          data: { labels, datasets:[{data:lockStat,label:"Lock",backgroundColor:lockStat.map(v=>v?"#2ecc71":"#e74c3c")} ] },
          options: { ...baseOpt, scales:{...baseOpt.scales, y:{beginAtZero:true,max:1,ticks:{callback:v=>v?"Unlocked":"Locked"}}} }
        });
        setLabel("lockValue", lockStat.at(-1) ? "Unlocked" : "Locked");

        /* ---------- MAP ---------- */
        const locs = locMsgs.map(m => {
          const p = m.payload;
          return {
            lat: p.lat ?? (Array.isArray(p.coordinates)?p.coordinates[1]:null),
            lon: p.lon ?? (Array.isArray(p.coordinates)?p.coordinates[0]:null),
            time: p.timestamp || Date.now()
          };
        }).filter(l => typeof l.lat === "number" && typeof l.lon === "number");

        if (locs.length) {
          const last = locs.at(-1);
          const map = L.map("map").setView([last.lat, last.lon], 15);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
          const marker = L.marker([last.lat,last.lon]).addTo(map);
          marker.bindPopup(`üö≤ ${new Date(last.time).toLocaleString()}`).openPopup();
          const path = locs.map(l=>[l.lat,l.lon]);
          L.polyline(path,{color:"blue",weight:3,opacity:0.7}).addTo(map);
        }

      } catch(e) {
        console.error(e);
        document.body.insertAdjacentHTML("beforeend",`<p style='color:red;'>${e.message}</p>`);
      }
    }

    function exportCSV() {
      if (!allData.length) return alert("No data");
      const header = ["topic","timestamp","battery","speed","mileage","lock_status","lat","lon"];
      const rows = allData.map(m => {
        const p = m.payload || {};
        const ts = p.timestamp ? new Date(p.timestamp).toISOString() : "";
        const lat = p.lat ?? (Array.isArray(p.coordinates)?p.coordinates[1]:"");
        const lon = p.lon ?? (Array.isArray(p.coordinates)?p.coordinates[0]:"");
        return [m.topic, ts, p.battery??"", p.speed??"", p.riding_mileage??"", p.lock_status??"", lat, lon].join(",");
      });
      const csv = [header.join(","), ...rows].join("\n");
      const url = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
      const a = document.createElement("a");
      a.href = url; a.download = "bike_telemetry.csv"; a.click(); URL.revokeObjectURL(url);
    }

    loadDashboard();
  </script>
</body>
</html>
