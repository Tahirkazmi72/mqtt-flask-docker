<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <!-- Charts & Map libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
    h1{margin-bottom:6px}
    h2{margin:24px 0 8px}

    /* --- CHART ROW --- */
    .chart-row{display:flex;align-items:center;gap:12px;margin:32px 0}
    .chart-row canvas{flex:0 0 75%;max-width:75%}
    .value-panel{flex:0 0 25%;max-width:25%;background:#fff;border:1px solid #ddd;border-radius:6px;padding:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .value-panel h3{margin:2px 0 4px;font-size:1rem;color:#555}
    .value-panel p{margin:0;font-size:1.25rem;font-weight:700;color:#111}

    #map{height:350px;border:1px solid #ccc;margin-top:32px}
    #map.empty{display:flex;align-items:center;justify-content:center;color:#666;font-style:italic}

    #controls{display:flex;align-items:center;gap:12px;margin:20px 0}
    #exportBtn, #controls label{padding:10px 20px;font-size:1rem;cursor:pointer;border:none;border-radius:4px;background:#3498db;color:#fff}
    #exportBtn:hover, #controls label:hover{background:#2980b9}
    #autoRefresh{margin-right:6px;cursor:pointer}
    #controls label{display:flex;align-items:center;background:#27ae60}
    #controls label:hover{background:#1e874b}
    #controls label span{user-select:none;color:#fff}

    @media(max-width:800px){
      .chart-row{flex-direction:column}
      .chart-row canvas,.value-panel{flex:0 0 100%;max-width:100%}
    }
  </style>
</head>
<body>
  <h1>üìä Bike Telemetry Dashboard</h1>
  <h2 id="lockerId">Locker ID: Unknown</h2>

  <div id="controls">
    <label><input type="checkbox" id="autoRefresh" checked><span>Auto‚ÄëRefresh (5¬†s)</span></label>
    <button id="exportBtn">üì• Export CSV</button>
  </div>

  <div class="chart-row">
    <canvas id="batteryChart"></canvas>
    <div class="value-panel"><h3>Battery</h3><p id="batteryValue">-- %</p></div>
  </div>

  <div class="chart-row">
    <canvas id="speedChart"></canvas>
    <div class="value-panel"><h3>Speed</h3><p id="speedValue">-- km/h</p></div>
  </div>

  <div class="chart-row">
    <canvas id="mileageChart"></canvas>
    <div class="value-panel"><h3>Mileage</h3><p id="mileageValue">-- km</p></div>
  </div>

  <div class="chart-row">
    <canvas id="lockChart"></canvas>
    <div class="value-panel"><h3>Lock</h3><p id="lockValue">--</p></div>
  </div>

  <h2>üìç Live Location Map</h2>
  <div id="map" class="empty">Loading map‚Ä¶</div>

  <script>
    let allData=[];
    const CHARTS={}; // store chart instances for reuse

    function fmt(val,unit=""){return (val||val===0)?`${val} ${unit}`.trim():"--"}
    const setLabel=(id,val,unit="")=>{const el=document.getElementById(id); if(el) el.textContent=fmt(val,unit)}

    // Robust timestamp formatter (HH:mm:ss)
    function formatTimestamp(ts){
      if(!ts && ts!==0) return "";
      let ms=ts;
      if(typeof ts==="number"){if(ts<1e12) ms=ts*1000;} // seconds‚Üíms
      else ms=Date.parse(ts);
      if(Number.isNaN(ms)) return "";
      const d=new Date(ms);
      return d.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    }

    async function fetchData(){
      const res=await fetch("/data");
      if(!res.ok) throw new Error(`Server ${res.status}`);
      const json=await res.json();
      if(!Array.isArray(json)||!json.length) throw new Error("No data returned");
      return json;
    }

    async function loadDashboard(){
      try{
        allData=await fetchData();

        // locker id (first message that contains it)
        const idMsg=allData.find(m=>m.payload&&m.payload.id);
        if(idMsg) document.getElementById("lockerId").textContent=`Locker ID: ${idMsg.payload.id}`;

        /* ================== LOCK MESSAGES ================== */
        const lockMsgs=allData.filter(m=>m.topic==="bike/lock"&&m.payload);

        const labels   = lockMsgs.map(m=>formatTimestamp(m.payload.timestamp));
        const battery  = lockMsgs.map(m=>m.payload.battery ?? null);
        const speed    = lockMsgs.map(m=>m.payload.speed ?? null);
        const mileage  = lockMsgs.map(m=>m.payload.riding_mileage ?? null);
        const lockStat = lockMsgs.map(m=>m.payload.lock_status==="Unlocked"?1:0);

        renderChart("batteryChart","line",labels,"Battery",battery,"#27ae60");
        renderChart("speedChart","line",labels,"Speed",speed,"#2980b9");
        renderChart("mileageChart","line",labels,"Mileage",mileage,"#e67e22");
        renderChart("lockChart","bar",labels,"Lock",lockStat,lockStat.map(v=>v?"#2ecc71":"#e74c3c"),true);

        setLabel("batteryValue",battery.at(-1),"%");
        setLabel("speedValue",speed.at(-1),"km/h");
        setLabel("mileageValue",mileage.at(-1),"km");
        setLabel("lockValue",lockStat.at(-1)?"Unlocked":"Locked");

        /* ================== LOCATION ================== */
        const locMsgs=allData.filter(m=>{
          const p=m.payload||{};
          return (typeof p.lat==="number"&&typeof p.lon==="number")||
                 (Array.isArray(p.coordinates)&&p.coordinates.length>=2&&typeof p.coordinates[0]==="number"&&typeof p.coordinates[1]==="number");
        });
        const locs=locMsgs.map(m=>{
          const p=m.payload||{};
          const lat=typeof p.lat==="number"?p.lat:(Array.isArray(p.coordinates)?p.coordinates[1]:null);
          const lon=typeof p.lon==="number"?p.lon:(Array.isArray(p.coordinates)?p.coordinates[0]:null);
          const time=p.timestamp??Date.now();
          return {lat,lon,time};
        }).filter(l=>typeof l.lat==="number"&&typeof l.lon==="number");
        setupMap(locs);

      }catch(err){
        console.error(err);
        const map=document.getElementById("map");
        map.textContent=`Error: ${err.message}`;
        map.classList.add("empty");
      }
    }

    // render or update chart
    function renderChart(canvasId,type,labels,label,data,color,lockChart=false){
      if(CHARTS[canvasId]){ // update existing chart
        CHARTS[canvasId].data.labels=labels;
        CHARTS[canvasId].data.datasets[0].data=data;
        if(lockChart){ CHARTS[canvasId].data.datasets[0].backgroundColor=color; }
        CHARTS[canvasId].update();
        return;
      }
      const optBase={
        responsive:true,
        plugins:{legend:{display:false}},
        scales:{
          x:{title:{display:true,text:"Time"},ticks:{maxRotation:45,minRotation:0,maxTicksLimit:8}},
          y:{beginAtZero:true}
        }
      };
      if(lockChart){
        optBase.scales.y={beginAtZero:true,max:1,ticks:{callback:v=>v?"Unlocked":"Locked"}};
      }
      CHARTS[canvasId]=new Chart(document.getElementById(canvasId),{
        type:type,
        data:{labels,datasets:[{label,data,borderColor:color,backgroundColor:color,fill:false,tension:0.4}]},
        options:optBase
      });
    }

    function setupMap(locs){
      const mapDiv=document.getElementById("map");
      mapDiv.classList.remove("empty");
      mapDiv.innerHTML="";
      if(!locs.length){
        mapDiv.classList.add("empty");
        mapDiv.textContent="No location data";
        return;
      }
      const latest=locs.at(-1);
      const map=L.map("map").setView([latest.lat,latest.lon],15);
      L.tileLayer("https://{
