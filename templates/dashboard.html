<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bike Telemetry Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 1rem; }
    .chart-wrapper { display: flex; align-items: center; margin-bottom: 2rem; }
    .chart-wrapper canvas { width: 75%; max-width: 100%; }
    .chart-info { width: 25%; padding-left: 1rem; font-size: 1.1rem; }
    #map { height: 400px; margin-top: 2rem; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1 id="lockerIdLabel">Locker ID: Unknown</h1>

  <!-- Battery Chart -->
  <div class="chart-wrapper">
    <canvas id="batteryChart"></canvas>
    <div class="chart-info" id="batteryInfo"></div>
  </div>

  <!-- Speed Chart -->
  <div class="chart-wrapper">
    <canvas id="speedChart"></canvas>
    <div class="chart-info" id="speedInfo"></div>
  </div>

  <!-- Riding Mileage Chart -->
  <div class="chart-wrapper">
    <canvas id="ridingChart"></canvas>
    <div class="chart-info" id="ridingInfo"></div>
  </div>

  <!-- Lock Status Chart -->
  <div class="chart-wrapper">
    <canvas id="lockChart"></canvas>
    <div class="chart-info" id="lockInfo"></div>
  </div>

  <h2>üìç Live Location Map</h2>
  <div id="map"></div>

  <button onclick="exportCSV()">üì• Export CSV with Location</button>

  <script>
    let filteredData = [];
    let allData = [];

    async function loadDashboard() {
      try {
        const response = await fetch("/data");
        if (!response.ok) throw new Error(`Server returned ${response.status}`);
        const data = await response.json();
        allData = Array.isArray(data) ? data : [];

        // bike/lock messages for charts
        filteredData = allData.filter(item => item.topic === "bike/lock" && item.payload && typeof item.payload.battery === "number");
        if (!filteredData.length) throw new Error("No 'bike/lock' data found.");

        // Show locker ID if available
        const firstPayload = filteredData[0].payload || {};
        if (firstPayload.id) {
          document.getElementById("lockerIdLabel").textContent = `Locker ID: ${firstPayload.id}`;
        }

        const labels = filteredData.map(item => {
          const ts = item.payload.timestamp;
          return ts ? new Date(ts).toLocaleString() : "";
        });

        const battery = filteredData.map(i => i.payload.battery);
        const speed = filteredData.map(i => i.payload.speed);
        const riding = filteredData.map(i => i.payload.riding_mileage);
        const lockStatus = filteredData.map(i => i.payload.lock_status === "Unlocked" ? 1 : 0);

        createLineChart('batteryChart', labels, battery, 'Battery (%)');
        createLineChart('speedChart', labels, speed, 'Speed (km/h)');
        createLineChart('ridingChart', labels, riding, 'Riding Mileage');
        createBarChart('lockChart', labels, lockStatus, 'Lock Status');

        // Side labels
        updateInfo('batteryInfo', battery.at(-1), '%', 'ÿ®€åŸπÿ±€å');
        updateInfo('speedInfo', speed.at(-1), 'km/h', 'ÿ±ŸÅÿ™ÿßÿ±');
        updateInfo('ridingInfo', riding.at(-1), 'km', 'ŸÅÿßÿµŸÑ€Å');
        updateInfo('lockInfo', lockStatus.at(-1) ? 'Unlocked' : 'Locked', '', 'ŸÑÿß⁄©');

        loadMap();
      } catch (err) {
        document.body.insertAdjacentHTML('beforeend', `<p style='color:red;'>${err.message}</p>`);
      }
    }

    function createLineChart(canvasId, labels, data, label) {
      new Chart(document.getElementById(canvasId), {
        type: 'line',
        data: { labels, datasets: [{ label, data, borderWidth: 2, fill: false, tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    }

    function createBarChart(canvasId, labels, data, label) {
      new Chart(document.getElementById(canvasId), {
        type: 'bar',
        data: { labels, datasets: [{ label, data }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 1 } } }
      });
    }

    function updateInfo(elId, value, unit, label) {
      const el = document.getElementById(elId);
      el.textContent = `${label}: ${value ?? 'N/A'} ${unit}`.trim();
    }

    function loadMap() {
      const locs = allData
        .filter(i => i.topic === 'bike/location' && i.payload)
        .map(i => ({
          lat: i.payload.lat ?? (Array.isArray(i.payload.coordinates) ? i.payload.coordinates[1] : null),
          lon: i.payload.lon ?? (Array.isArray(i.payload.coordinates) ? i.payload.coordinates[0] : null),
          time: i.payload.timestamp ?? ''
        }))
        .filter(l => typeof l.lat === 'number' && typeof l.lon === 'number');

      if (!locs.length) return;
      const latest = locs.at(-1);
      const map = L.map('map').setView([latest.lat, latest.lon], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
      const marker = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/747/747376.png', iconSize: [32, 32] });
      L.marker([latest.lat, latest.lon], { icon: marker }).addTo(map).bindPopup(`üïì ${new Date(latest.time).toLocaleString()}`);
      L.polyline(locs.map(l => [l.lat, l.lon]), { color: 'blue', weight: 4 }).addTo(map);
    }

    function exportCSV() {
      if (!allData.length) { alert('No data to export.'); return; }
      const headers = ['Timestamp', 'Battery', 'Speed', 'Riding Mileage', 'Lock Status', 'Latitude', 'Longitude'];
      const rows = allData.map(item => {
        const p = item.payload || {};
        const ts = p.timestamp ? new Date(p.timestamp).toISOString() : '';
        const battery = p.battery ?? '';
        const speed = p.speed ?? '';
        const riding = p.riding_mileage ?? '';
        const status = p.lock_status ?? '';
        const lat = p.lat ?? (Array.isArray(p.coordinates) ? p.coordinates[1] : '');
        const lon = p.lon ?? (Array.isArray(p.coordinates) ? p.coordinates[0] : '');
        return [ts, battery, speed, riding, status, lat, lon].join(',');
      });
      const blob = new Blob([headers.join(',') + '\n' + rows.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bike_data.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    loadDashboard();
  </script>
</body>
</html>
